name: "Test - QA"

on: [ workflow_dispatch ]

jobs:
  test-qa:
    name: Test::QA
    runs-on: self-hosted

    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%y%m%d-%H%M')"

      - name: Test App
        id: runTests
        continue-on-error: true
        run: mvn -Ptesting-only -Dtest.url=https://qa.yals.ee -Dgrid.hostname=http://grid.kio.ee -Dselenide.browser=chrome -Dtest.buildName=yalsee-qa-${{ steps.date.outputs.date }} -Dapp.shortUrl=https://q.yls.ee -Dtest.deleteToken=${{ secrets.QA_DELETE_TOKEN }} clean test
        env:
          JAVA_HOME: /srv/java17

      - name: Publish Screenshots of failing tests (if any)
        uses: actions/upload-artifact@v3
        continue-on-error: true
        with:
          name: failedTests
          path: target/reports/**/*.png
          if-no-files-found: ignore

      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1.39
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_name: QA Unit Test Results
          comment_title: QA Unit Test Statistics
          hide_comments: all but latest
          comment_mode: 'always'
          test_changes_limit: 5
          files: target/surefire-reports/**/*.xml
          report_individual_runs: true
          deduplicate_classes_by_file_name: false
          check_run_annotations: all tests, skipped tests

      - name: Delete Test Video (No failed tests)
        if: steps.runTests.outcome == 'success'
        uses: wei/curl@master
        with:
          args: -X DELETE -H "X-Token:${{ secrets.GRID_API_TOKEN }}" ${{ secrets.GRID_API_ENDPOINT }}/videos/yalsee-qa-${{ steps.date.outputs.date }}
